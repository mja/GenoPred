<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Prediction within Ancestral Diversity</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/united.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<link href="site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet" />
<link href="site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet" />

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>




<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">GenoPred</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/opain/GenoPred">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Prediction within Ancestral Diversity</h1>

</div>


<style>
p.caption {
  font-size: 1.5em;
}
</style>
<style type="text/css">
pre code, pre, code {
  white-space: pre !important;
  overflow-x: scroll !important;
  word-break: keep-all !important;
  word-wrap: initial !important;
}
</style>
<hr />
<div id="introduction" class="section level1">
<h1><span class="header-section-number">1</span> Introduction</h1>
<p>Genotype-based prediction is more accurate within European populations due to European-based GWAS being larger in sample size, and the relatively low admixture within European populations compared to non-European populations. Apart from phenotypic heterogenity across populations, a key reason why European GWAS do not predict well in non-European populations is due to differences in LD and MAF. Although the underlying causal variant maybe the same across populations, the variant best tagging the causal variant in one population may not wel tag the causal variant in another population.</p>
<p>Prediction in non-European populations by:</p>
<ul>
<li>Performing larger GWAS in non-European populations</li>
<li>Combination of European-GWAS with existing non-European GWAS</li>
<li>Modelling differences in MAF and LD between populations</li>
<li>Using gene-based scores</li>
</ul>
<p>Across the genome some regions will be more comparable across populations than others. Furthermore, within an individual there is often a mixture of haplotypes from different populations (admixture), meaning a European GWAS maybe predictive for an individual for certain regions only. Merely by removing loci that do not generalise across populations well may improve prediction by reducing noise.</p>
<hr />
</div>
<div id="evaluate-prediction-across-a-range-of-ancestries" class="section level1">
<h1><span class="header-section-number">2</span> Evaluate prediction across a range of ancestries</h1>
<p>Global ancestry is typically defined using reference-projected genotype-based principal components. Often individuals are said to be of a population if they are within N SD of the population mean. Alternatively principal component estimates can be used in a machine learning based approach such as k-means clustering. I have used an elastic net model to predict global ancestry.</p>
<p>Estimate the predictive utility of polygenic scores within each super population. UKB contains individuals within each super population.</p>
<hr />
<div id="defining-ancestry-and-qc" class="section level2">
<h2><span class="header-section-number">2.1</span> Defining ancestry and QC</h2>
<p>Further information can be found here: <a href="https://opain.github.io/UKB-GenoPrep/" class="uri">https://opain.github.io/UKB-GenoPrep/</a></p>
</div>
<div id="prepare-phenotype-files" class="section level2">
<h2><span class="header-section-number">2.2</span> Prepare phenotype files</h2>
<details>
<p><summary>Show code</summary></p>
<pre class="r"><code>source(&#39;/users/k1806347/brc_scratch/Software/MyGit/GenoPred/config_used/Phenotype_prep.config&#39;)
library(data.table)

# Read list of individuals surviving QC in each population
# Read in fam to convert row number to application specific ID
# Row numbers in pheno file cannot be trusted
fam&lt;-fread(&#39;/scratch/groups/ukbiobank/ukb18177_glanville/genotyped/ukb18177_glanville_binary_pre_qc.fam&#39;)
fam$V1&lt;-seq(1:dim(fam)[1])

fam_2&lt;-fread(paste0(UKBB_output,&#39;/Genotype/Harmonised/UKBB.w_hm3.QCd.AllSNP.chr22.fam&#39;))

fam_merged&lt;-merge(fam, fam_2, by=&#39;V2&#39;)

keep&lt;-list()
for(pop in c(&#39;EUR&#39;,&#39;AFR&#39;,&#39;SAS&#39;,&#39;EAS&#39;,&#39;AMR&#39;)){
  keep[[pop]]&lt;-fread(paste0(&#39;/scratch/groups/ukbiobank/usr/ollie_pain/ReQC/PostQC/UKB.postQC.&#39;,pop,&#39;.keep&#39;))
  keep[[pop]]&lt;-merge(keep[[pop]][,1], fam[,1:2], by=&#39;V1&#39;)
  keep[[pop]]$V1&lt;-keep[[pop]]$V2
  
  keep_tmp&lt;-fread(paste0(&#39;/scratch/groups/ukbiobank/usr/ollie_pain/ReQC/PostQC/UKB.postQC.&#39;,pop,&#39;.keep&#39;))
  keep_tmp&lt;-merge(keep_tmp[,1], fam_merged, by.x=&#39;V1&#39;, by.y=&#39;V1.x&#39;)
  keep_tmp&lt;-keep_tmp[,c(&#39;V1.y&#39;,&#39;V2&#39;),with=F]

    # Save keep file with updated IDs
  write.table(keep[[pop]], paste0(UKBB_output,&#39;/Phenotype/&#39;,pop,&#39;.QC.keep&#39;), col.names=F, row.names=F, quote=F)
  write.table(keep_tmp, paste0(UKBB_output,&#39;/Phenotype/&#39;,pop,&#39;.QC.UpdateIDs.keep&#39;), col.names=F, row.names=F, quote=F)
}

# Read in phenotype data
pheno&lt;-c(&#39;Depression&#39;,&#39;Intelligence&#39;,&#39;BMI&#39;,&#39;Height&#39;,&#39;T2D&#39;,&#39;CAD&#39;,&#39;IBD&#39;,&#39;MultiScler&#39;,&#39;RheuArth&#39;)
pheno_file&lt;-c(&#39;ever_depressed_pheno_final.UpdateIDs.txt&#39;,&#39;UKBB_Fluid.intelligence.score.UpdateIDs.pheno&#39;,&#39;UKBB_BMI.score.UpdateIDs.pheno&#39;,&#39;UKBB_Height.score.UpdateIDs.pheno&#39;,&#39;t2d_only_111119.UpdateIDs.txt&#39;,&#39;cad_only_111119.UpdateIDs.txt&#39;,&#39;UKBB.IBD.txt&#39;,&#39;UKBB.MultiScler.txt&#39;,&#39;UKBB.RheuArth.txt&#39;)

pheno_list&lt;-list()
for(i in 1:length(pheno)){
  pheno_list[[pheno[i]]]&lt;-fread(paste0(UKBB_output,&#39;/Phenotype/&#39;,pheno[i],&#39;/&#39;,pheno_file[i]))
}

pheno_all&lt;-Reduce(function(...) merge(..., all=T, by=c(&#39;FID&#39;,&#39;IID&#39;)), pheno_list)
names(pheno_all)&lt;-c(&#39;FID&#39;,&#39;IID&#39;,pheno)

# Count number of non-missing values for phenotype in each population 
pheno_dat_per_pop&lt;-NULL
for(pop in c(&#39;EUR&#39;,&#39;AFR&#39;,&#39;SAS&#39;,&#39;EAS&#39;,&#39;AMR&#39;)){
  pheno_all_pop&lt;-pheno_all[(pheno_all$IID %in% keep[[pop]]$V1),]
  for(i in 1:length(pheno)){
    if(length(na.omit(unique(pheno_all[[pheno[i]]]))) == 2){
          pheno_dat_per_pop&lt;-rbind(pheno_dat_per_pop, data.frame(Pop=pop,
                                                           Phenotype=pheno[i],
                                                           N=sum(!is.na(pheno_all_pop[[pheno[i]]])),
                                                           Ncase=sum(pheno_all_pop[[pheno[i]]] == 1, na.rm=T),
                                                           Ncon=sum(pheno_all_pop[[pheno[i]]] == 0, na.rm=T)))

    } else {
          pheno_dat_per_pop&lt;-rbind(pheno_dat_per_pop, data.frame(Pop=pop,
                                                           Phenotype=pheno[i],
                                                           N=sum(!is.na(pheno_all_pop[[pheno[i]]])),
                                                           Ncase=NA,
                                                           Ncon=NA))

    }
  }
}

# Idenitfy phenotype with at least 1000 indidivuals and 50 cases with data
pheno_dat_per_pop_retain&lt;-pheno_dat_per_pop[which((pheno_dat_per_pop$N &gt;=500 &amp; pheno_dat_per_pop$Ncase &gt;= 50) | (pheno_dat_per_pop$N &gt;=500 &amp; is.na(pheno_dat_per_pop$Ncase))),]

# BMI and Height are the only phenotypes meeting these criteria. This is fine for a preliminary analysis, but other phenotypes that are more available across ancestries should be explored. Intelligence was also available in EUR, AFR, and SAS.

# Save keep file with updated IDs for each phenotype, restricting the sample size to 50K
# Read in fam file with ID to match
system(paste0(&#39;mkdir &#39;,UKBB_output,&#39;/DiverseAncestry/Phenotype_subsets/&#39;))

set.seed(1)
for(pop in c(&#39;EUR&#39;,&#39;AFR&#39;,&#39;SAS&#39;,&#39;EAS&#39;,&#39;AMR&#39;)){
  for(pheno_i in c(&#39;BMI&#39;,&#39;Height&#39;)){
      pheno_all_pop&lt;-pheno_all[(pheno_all$IID %in% keep[[pop]]$V1),c(&#39;FID&#39;,&#39;IID&#39;,pheno_i), with=F]
      pheno_all_pop&lt;-pheno_all_pop[complete.cases(pheno_all_pop),]
      if(dim(pheno_all_pop)[1] &gt; 50000){
        pheno_all_pop&lt;-pheno_all_pop[sample(1:50000),]
      }
      
      write.table(pheno_all_pop[,1:2], paste0(UKBB_output,&#39;/DiverseAncestry/Phenotype_subsets/UKB.&#39;,pheno_i,&#39;.&#39;,pop,&#39;.QC.keep&#39;), col.names=F, row.names=F, quote=F)
  }
}</code></pre>
</details>
<hr />
</div>
<div id="calculate-scores" class="section level2">
<h2><span class="header-section-number">2.3</span> Calculate scores</h2>
<details>
<p><summary>pT + clump: Sparse</summary></p>
<pre class="bash"><code># Set required variables
. /users/k1806347/brc_scratch/Software/MyGit/GenoPred/config_used/Target_scoring.config

# Create variable listing phenotypes and corresponding GWAS
pheno=$(echo BMI Height)
gwas=$(echo BODY03 HEIG03)

# Calculate polygenic scores using 1KG reference
for i in $(seq 1 2);do
  for pop in $(echo AFR AMR EAS EUR SAS);do
    pheno_i=$(echo ${pheno} | cut -f ${i} -d &#39; &#39;)
    gwas_i=$(echo ${gwas} | cut -f ${i} -d &#39; &#39;)
  
    sbatch --mem 2G -p brc,shared -J pT_clump /users/k1806347/brc_scratch/Software/Rscript.sh /users/k1806347/brc_scratch/Software/MyGit/GenoPred/Scripts/Scaled_polygenic_scorer/Scaled_polygenic_scorer.R \
      --target_plink_chr ${UKBB_output}/Genotype/Harmonised/UKBB.w_hm3.QCd.AllSNP.chr \
      --target_keep ${UKBB_output}/DiverseAncestry/Phenotype_subsets/UKB.${pheno_i}.${pop}.QC.keep \
      --ref_score ${Geno_1KG_dir}/Score_files_for_poylygenic/${gwas_i}/1KGPhase3.w_hm3.${gwas_i} \
      --ref_scale ${Geno_1KG_dir}/Score_files_for_poylygenic/${gwas_i}/1KGPhase3.w_hm3.${gwas_i}.${pop}.scale \
      --ref_freq_chr ${Geno_1KG_dir}/freq_files/${pop}/1KGPhase3.w_hm3.${pop}.chr \
      --plink ${plink1_9} \
      --pheno_name ${gwas_i} \
      --output ${UKBB_output}/DiverseAncestry/1KG_ref/pt_clump/${pop}/${gwas_i}/UKBB.${pop}.w_hm3.${gwas_i}
  done
done
</code></pre>
</details>
<details>
<p><summary>GeRS</summary></p>
<pre class="bash"><code>. /users/k1806347/brc_scratch/Software/MyGit/GenoPred/config_used/Target_scoring.config

# Create variable listing phenotypes and corresponding GWAS
pheno=$(echo BMI Height)
gwas=$(echo BODY03 HEIG03)

# Calculate polygenic scores using 1KG reference
for pop in $(echo AFR AMR EAS EUR SAS);do
  mkdir -p ${UKBB_output}/GeRS_for_diversity/1KG_ref/${pop}
  &gt; ${UKBB_output}/GeRS_for_diversity/1KG_ref/${pop}/todo.txt
  for i in $(seq 1 2);do
    pheno_i=$(echo ${pheno} | cut -f ${i} -d &#39; &#39;)
    gwas_i=$(echo ${gwas} | cut -f ${i} -d &#39; &#39;)
    
    for weights in $(cat ~/brc_scratch/Data/TWAS_sumstats/FUSION/snp_weight_list.txt);do
      if [ ! -f ${UKBB_output}/GeRS_for_diversity/1KG_ref/${pop}/${weights}/UKBB.w_hm3.EUR.${weights}.${gwas_i}.fiprofile ]; then
        echo $gwas_i $pheno_i $weights &gt;&gt; ${UKBB_output}/GeRS_for_diversity/1KG_ref/${pop}/todo.txt
      fi
    done
  done
cat &lt;&lt;EOF &gt;${UKBB_output}/GeRS_for_diversity/1KG_ref/${pop}/todo_array.sh
#!/bin/bash
#SBATCH -p shared,brc
#SBATCH --mem 10G
#SBATCH -n 1

. /users/k1806347/brc_scratch/Software/MyGit/GenoPred/config_used/Target_scoring.config

gwas=\$(awk -v var=\${SLURM_ARRAY_TASK_ID} &#39;NR == var {print \$1}&#39; ${UKBB_output}/GeRS_for_diversity/1KG_ref/${pop}/todo.txt)
pheno=\$(awk -v var=\${SLURM_ARRAY_TASK_ID} &#39;NR == var {print \$2}&#39; ${UKBB_output}/GeRS_for_diversity/1KG_ref/${pop}/todo.txt)
weights=\$(awk -v var=\${SLURM_ARRAY_TASK_ID} &#39;NR == var {print \$3}&#39; ${UKBB_output}/GeRS_for_diversity/1KG_ref/${pop}/todo.txt)

/users/k1806347/brc_scratch/Software/Rscript.sh /users/k1806347/brc_scratch/Software/MyGit/GenoPred/Scripts/scaled_functionally_informed_risk_scorer/scaled_functionally_informed_risk_scorer.R \
  --targ_feature_pred ${UKBB_output}/Predicted_expression/FUSION/${pop}/\${weights}/UKBB.w_hm3.QCd.AllSNP.FUSION.\${weights}.predictions.gz \
  --target_keep ${UKBB_output}/DiverseAncestry/Phenotype_subsets/UKB.\${pheno}.${pop}.QC.keep \
  --ref_score ${Geno_1KG_dir}/Score_files_for_functionally_informed_risk_scores/\${gwas}/1KGPhase3.w_hm3.EUR.FUSION.\${gwas}.\${weights}.score \
  --ref_scale ${Geno_1KG_dir}/Score_files_for_functionally_informed_risk_scores/\${gwas}/1KGPhase3.w_hm3.EUR.FUSION.\${gwas}.\${weights}.scale \
  --pheno_name \${gwas} \
  --n_cores 1 \
  --pigz ${pigz_binary} \
  --output ${UKBB_output}/GeRS_for_diversity/1KG_ref/${pop}/\${weights}/UKBB.w_hm3.EUR.\${weights}.\${gwas}

EOF
done

for pop in $(echo AMR);do
sbatch --array=1-$(wc -l ${UKBB_output}/GeRS_for_diversity/1KG_ref/${pop}/todo.txt | cut -d &#39; &#39; -f 1)%10 ${UKBB_output}/GeRS_for_diversity/1KG_ref/${pop}/todo_array.sh
done
</code></pre>
</details>
<p>Note. Using colocalised score files might do better across ancestries</p>
<hr />
</div>
<div id="evaluate-scores" class="section level2">
<h2><span class="header-section-number">2.4</span> Evaluate scores</h2>
<details>
<p><summary>pT + clump comparison</summary></p>
<pre class="bash"><code>##############################
# Evaluating predictive utility of pT + clump PRSs across multiple pTs individually and in combination
##############################
. /users/k1806347/brc_scratch/Software/MyGit/GenoPred/config_used/Target_scoring.config

# Make required directories
for pheno_i in $(echo BMI Height);do
mkdir -p /users/k1806347/brc_scratch/Analyses/DiverseAncestry/UKBB_outcomes_for_prediction/${pheno_i}/Association_withPRSs
done

# Create a file listing the predictors files
pheno=$(echo BMI Height)
gwas=$(echo BODY03 HEIG03)

for i in $(seq 1 2);do
pheno_i=$(echo ${pheno} | cut -f ${i} -d &#39; &#39;)
gwas_i=$(echo ${gwas} | cut -f ${i} -d &#39; &#39;)
for pop in $(echo AFR AMR EAS EUR SAS);do
cat &gt; /users/k1806347/brc_scratch/Analyses/DiverseAncestry/UKBB_outcomes_for_prediction/${pheno_i}/Association_withPRSs/UKBB.${pop}.w_hm3.${gwas_i}.EUR-PRSs.predictor_groups &lt;&lt;EOF
predictors 
${UKBB_output}/DiverseAncestry/1KG_ref/pt_clump/${pop}/${gwas_i}/UKBB.${pop}.w_hm3.${gwas_i}.profiles
EOF
done
done

# Derive and evaluate models
pheno=$(echo BMI Height)
pheno_file=$(echo UKBB_BMI.score.UpdateIDs.pheno UKBB_Height.score.UpdateIDs.pheno)
gwas=$(echo BODY03 HEIG03)
prev=$(echo NA NA)

# pT + clump (sparse)
for i in $(seq 1 2);do
  pheno_i=$(echo ${pheno} | cut -f ${i} -d &#39; &#39;)
  pheno_file_i=$(echo ${pheno_file} | cut -f ${i} -d &#39; &#39;)
  gwas_i=$(echo ${gwas} | cut -f ${i} -d &#39; &#39;)
  prev_i=$(echo ${prev} | cut -f ${i} -d &#39; &#39;)

  for pop in $(echo AFR AMR EAS EUR SAS);do
  sbatch --mem 10G -n 1 -p brc,shared /users/k1806347/brc_scratch/Software/Rscript.sh /users/k1806347/brc_scratch/Software/MyGit/GenoPred/Scripts/Model_builder/Model_builder_V2_nested.R \
      --pheno ${UKBB_output}/Phenotype/${pheno_i}/${pheno_file_i} \
      --out /users/k1806347/brc_scratch/Analyses/DiverseAncestry/UKBB_outcomes_for_prediction/${pheno_i}/Association_withPRSs/UKBB.${pop}.w_hm3.${gwas_i}.EUR-PRSs \
      --n_core 1 \
      --compare_predictors T \
      --assoc T \
      --outcome_pop_prev ${prev_i} \
      --predictors /users/k1806347/brc_scratch/Analyses/DiverseAncestry/UKBB_outcomes_for_prediction/${pheno_i}/Association_withPRSs/UKBB.${pop}.w_hm3.${gwas_i}.EUR-PRSs.predictor_groups
  done
done
</code></pre>
</details>
<details>
<p><summary>GeRS + PRS</summary></p>
<pre class="bash"><code>##############################
# Evaluating predictive utility of GeRS and PRS individually and in combination
##############################
. /users/k1806347/brc_scratch/Software/MyGit/GenoPred/config_used/Target_scoring.config

# Make required directories
for pheno_i in $(echo BMI Height);do
mkdir -p /users/k1806347/brc_scratch/Analyses/DiverseAncestry/UKBB_outcomes_for_prediction/${pheno_i}/Association_withPRS_and_GeRSs
done

# Create a file listing the predictors files
pheno=$(echo BMI Height)
gwas=$(echo BODY03 HEIG03)
weights=$(cat ${TWAS_rep}/snp_weight_list.txt)

for i in $(seq 1 2);do
  for pop in $(echo AFR AMR EAS EUR SAS);do
    pheno_i=$(echo ${pheno} | cut -f ${i} -d &#39; &#39;)
    gwas_i=$(echo ${gwas} | cut -f ${i} -d &#39; &#39;)
    
    echo &quot;predictors group&quot; &gt; /users/k1806347/brc_scratch/Analyses/DiverseAncestry/UKBB_outcomes_for_prediction/${pheno_i}/Association_withPRS_and_GeRSs/UKBB.w_hm3.AllTissue.${gwas_i}.${pop}-GeRSs.${pop}-PRSs.pt_clump.predictor_groups
  
    for weight in ${weights}; do
      if [ -f ${UKBB_output}/GeRS_for_diversity/1KG_ref/${pop}/${weight}/UKBB.w_hm3.EUR.${weight}.${gwas_i}.fiprofile ]; then
        echo ${UKBB_output}/GeRS_for_diversity/1KG_ref/${pop}/${weight}/UKBB.w_hm3.EUR.${weight}.${gwas_i}.fiprofile GeRS &gt;&gt; /users/k1806347/brc_scratch/Analyses/DiverseAncestry/UKBB_outcomes_for_prediction/${pheno_i}/Association_withPRS_and_GeRSs/UKBB.w_hm3.AllTissue.${gwas_i}.${pop}-GeRSs.${pop}-PRSs.pt_clump.predictor_groups
      fi
    done
  
      echo ${UKBB_output}/DiverseAncestry/1KG_ref/pt_clump/${pop}/${gwas_i}/UKBB.${pop}.w_hm3.${gwas_i}.profiles PRS &gt;&gt; /users/k1806347/brc_scratch/Analyses/DiverseAncestry/UKBB_outcomes_for_prediction/${pheno_i}/Association_withPRS_and_GeRSs/UKBB.w_hm3.AllTissue.${gwas_i}.${pop}-GeRSs.${pop}-PRSs.pt_clump.predictor_groups
  done
done

# Derive and evaluate models
pheno=$(echo BMI Height)
pheno_file=$(echo UKBB_BMI.score.UpdateIDs.pheno UKBB_Height.score.UpdateIDs.pheno)
gwas=$(echo BODY03 HEIG03)
prev=$(echo NA NA)

# 1KG reference
for i in $(seq 1 2);do
  pheno_i=$(echo ${pheno} | cut -f ${i} -d &#39; &#39;)
  pheno_file_i=$(echo ${pheno_file} | cut -f ${i} -d &#39; &#39;)
  gwas_i=$(echo ${gwas} | cut -f ${i} -d &#39; &#39;)
  prev_i=$(echo ${prev} | cut -f ${i} -d &#39; &#39;)

  for pop in $(echo AMR);do
sbatch --mem 10G -n 4 -p brc,shared /users/k1806347/brc_scratch/Software/Rscript.sh /users/k1806347/brc_scratch/Software/MyGit/GenoPred/Scripts/Model_builder/Model_builder_V2_nested.R \
    --pheno ${UKBB_output}/Phenotype/${pheno_i}/${pheno_file_i} \
    --out /users/k1806347/brc_scratch/Analyses/DiverseAncestry/UKBB_outcomes_for_prediction/${pheno_i}/Association_withPRS_and_GeRSs/UKBB.w_hm3.AllTissue.${gwas_i}.${pop}-GeRSs.${pop}-PRSs.pt_clump \
    --n_core 4 \
    --compare_predictors F \
    --assoc T \
    --outcome_pop_prev ${prev_i} \
    --predictors /users/k1806347/brc_scratch/Analyses/DiverseAncestry/UKBB_outcomes_for_prediction/${pheno_i}/Association_withPRS_and_GeRSs/UKBB.w_hm3.AllTissue.${gwas_i}.${pop}-GeRSs.${pop}-PRSs.pt_clump.predictor_groups
done
done
</code></pre>
</details>
<hr />
</div>
<div id="plot-the-results" class="section level2">
<h2><span class="header-section-number">2.5</span> Plot the results</h2>
<details>
<p><summary>pT + clump comparison</summary></p>
<pre class="r"><code>pop&lt;-c(&#39;AFR&#39;,&#39;AMR&#39;,&#39;EAS&#39;,&#39;EUR&#39;,&#39;SAS&#39;)
pheno&lt;-c(&#39;BMI&#39;,&#39;Height&#39;)
gwas&lt;-c(&#39;BODY03&#39;,&#39;HEIG03&#39;)

library(data.table)
res&lt;-list()
for(i in 1:length(gwas)){
  res_pheno&lt;-NULL
  for(k in 1:length(pop)){
    tmp&lt;-fread(paste0(&#39;/users/k1806347/brc_scratch/Analyses/DiverseAncestry/UKBB_outcomes_for_prediction/&#39;,pheno[i],&#39;/Association_withPRSs/UKBB.&#39;,pop[k],&#39;.w_hm3.&#39;,gwas[i],&#39;.EUR-PRSs.pred_eval.txt&#39;))
    tmp2&lt;-data.frame( Population=pop[k],
                      Phenotype=pheno[i],
                      tmp)
    
    res_pheno&lt;-rbind(res_pheno, tmp2)
  }

  res_pheno$Model&lt;-gsub(&#39;e.&#39;,&#39;e-&#39;,gsub(&#39;_.*&#39;,&#39;&#39;,gsub(paste0(gwas[i],&#39;.&#39;),&#39;&#39;,res_pheno$Model)))
  res_pheno$Model&lt;-factor(res_pheno$Model, levels=unique(res_pheno$Model))
  res[[pheno[i]]]&lt;-res_pheno
}

library(ggplot2)
library(cowplot)

plot_list&lt;-NULL
for(i in 1:length(gwas)){
  plot_list[[pheno[i]]]&lt;-ggplot(res[[pheno[i]]], aes(x=factor(Model), y=R, colour=Population)) +
                            geom_point(stat=&quot;identity&quot;, position=position_dodge( width=.25)) +
                            geom_errorbar(aes(ymin=R-SE, ymax=R+SE), width=.2, position=position_dodge(.25)) +
                            theme_half_open() +
                            ylim(0,NA) +
                            theme(axis.text.x = element_text(angle = 55, vjust = 1, hjust=1), plot.title = element_text(hjust = 0.4, size=12)) +
                            background_grid(major = &#39;y&#39;, minor = &#39;y&#39;) +
                            labs(x=&#39;pT&#39;,y=&#39;Predicted-Observed Correlation&#39;, title=pheno[i])
}

png(&#39;/users/k1806347/brc_scratch/Analyses/DiverseAncestry/UKBB_outcomes_for_prediction/UKB.Diverse.pTclump_per_pT.png&#39;, units=&#39;px&#39;, res=300, width=2000, height=3000)
  plot_grid(plotlist=plot_list, ncol = 1)
dev.off()</code></pre>
</details>
<details>
<p><summary>GeRS and pT+clump comparison</summary></p>
<pre class="r"><code>pop&lt;-c(&#39;AMR&#39;,&#39;EAS&#39;,&#39;EUR&#39;)
pheno&lt;-c(&#39;BMI&#39;,&#39;Height&#39;)
gwas&lt;-c(&#39;BODY03&#39;,&#39;HEIG03&#39;)

library(data.table)
res&lt;-list()
for(i in 1:length(gwas)){
  res_pheno&lt;-NULL
  for(k in 1:length(pop)){
    tmp&lt;-fread(paste0(&#39;/users/k1806347/brc_scratch/Analyses/DiverseAncestry/UKBB_outcomes_for_prediction/&#39;,pheno[i],&#39;/Association_withPRS_and_GeRSs/UKBB.w_hm3.AllTissue.&#39;,gwas[i],&#39;.&#39;,pop[k],&#39;-GeRSs.&#39;,pop[k],&#39;-PRSs.pt_clump.pred_eval.txt&#39;))
    tmp2&lt;-data.frame( Population=pop[k],
                      Phenotype=pheno[i],
                      tmp)
    
    res_pheno&lt;-rbind(res_pheno, tmp2)
  }

  res_pheno$Model&lt;-gsub(&#39;_group&#39;,&#39;&#39;,res_pheno$Model)
  res_pheno$Model&lt;-factor(res_pheno$Model, levels=unique(res_pheno$Model))
  res[[pheno[i]]]&lt;-res_pheno
}

library(ggplot2)
library(cowplot)

plot_list&lt;-NULL
for(i in 1:length(gwas)){
  plot_list[[pheno[i]]]&lt;-ggplot(res[[pheno[i]]], aes(x=factor(Model), y=R, colour=Population)) +
                            geom_point(stat=&quot;identity&quot;, position=position_dodge( width=.30)) +
                            geom_errorbar(aes(ymin=R-SE, ymax=R+SE), width=.2, position=position_dodge(.30)) +
                            theme_half_open() +
                            theme(axis.text.x = element_text(angle = 55, vjust = 1, hjust=1), plot.title = element_text(hjust = 0.4, size=12)) +
                            background_grid(major = &#39;y&#39;, minor = &#39;y&#39;) +
                            labs(x=&#39;pT&#39;,y=&quot;Correlation (SE)&quot;, title=pheno[i])
  
  if(i != length(gwas)){
    plot_list[[pheno[i]]]&lt;-plot_list[[pheno[i]]] + theme(legend.position = &quot;none&quot;)
  }
}

png(&#39;/users/k1806347/brc_scratch/Analyses/DiverseAncestry/UKBB_outcomes_for_prediction/UKB.Diverse.GeRS_vs_pTclump.png&#39;, units=&#39;px&#39;, res=300, width=1750, height=600)
  plot_grid(plotlist=plot_list, nrow = 1, rel_widths = c(1.2/3, 1.8/3))
dev.off()

res_2&lt;-list()
for(i in 1:length(gwas)){
  res_2_pheno&lt;-NULL
  for(k in 1:length(pop)){
    tmp&lt;-fread(paste0(&#39;/users/k1806347/brc_scratch/Analyses/DiverseAncestry/UKBB_outcomes_for_prediction/&#39;,pheno[i],&#39;/Association_withPRS_and_GeRSs/UKBB.w_hm3.AllTissue.&#39;,gwas[i],&#39;.&#39;,pop[k],&#39;-GeRSs.&#39;,pop[k],&#39;-PRSs.pt_clump.pred_comp.txt&#39;))
    tmp&lt;-tmp[tmp$Model_1 == &#39;All&#39; &amp; tmp$Model_2 == &#39;PRS&#39;,]
    tmp2&lt;-data.frame( Population=pop[k],
                      Phenotype=pheno[i],
                      tmp)
    
    res_2_pheno&lt;-rbind(res_2_pheno, tmp2)
  }

  res_2_pheno$Model_1&lt;-&#39;GeRS + PRS&#39;
  res_2_pheno$Model_2&lt;-&#39;PRS only&#39;
  res_2[[pheno[i]]]&lt;-res_2_pheno
}

res_2_all&lt;-do.call(rbind, res_2)
write.csv(res_2_all, &#39;/users/k1806347/brc_scratch/Analyses/DiverseAncestry/UKBB_outcomes_for_prediction/UKB.Diverse.GeRS_vs_pTclump.csv&#39;, row.names=F, quote=F)</code></pre>
</details>
<hr />
<div class="figure">
<img src="Images/UKB.Diverse.pTclump_per_pT.png" alt="pT+clump prediction across populations" />
<p class="caption">pT+clump prediction across populations</p>
</div>
<hr />
<div class="figure">
<img src="Images/UKB.Diverse.GeRS_vs_pTclump.png" alt="pT+clump prediction across populations" />
<p class="caption">pT+clump prediction across populations</p>
</div>
<table>
<caption>Difference between GeRS+PRS model and PRS only model</caption>
<thead>
<tr class="header">
<th align="left">Population</th>
<th align="left">Phenotype</th>
<th align="left">Model_1</th>
<th align="left">Model_2</th>
<th align="right">Model_1_R</th>
<th align="right">Model_2_R</th>
<th align="right">R_diff</th>
<th align="left">R_diff_pval</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">AMR</td>
<td align="left">BMI</td>
<td align="left">GeRS + PRS</td>
<td align="left">PRS only</td>
<td align="right">0.155</td>
<td align="right">0.138</td>
<td align="right">0.017</td>
<td align="left">3.03e-01</td>
</tr>
<tr class="even">
<td align="left">EAS</td>
<td align="left">BMI</td>
<td align="left">GeRS + PRS</td>
<td align="left">PRS only</td>
<td align="right">0.268</td>
<td align="right">0.217</td>
<td align="right">0.051</td>
<td align="left">2.77e-05</td>
</tr>
<tr class="odd">
<td align="left">EUR</td>
<td align="left">BMI</td>
<td align="left">GeRS + PRS</td>
<td align="left">PRS only</td>
<td align="right">0.279</td>
<td align="right">0.277</td>
<td align="right">0.003</td>
<td align="left">4.46e-04</td>
</tr>
<tr class="even">
<td align="left">AMR</td>
<td align="left">Height</td>
<td align="left">GeRS + PRS</td>
<td align="left">PRS only</td>
<td align="right">0.270</td>
<td align="right">0.218</td>
<td align="right">0.052</td>
<td align="left">5.65e-03</td>
</tr>
<tr class="odd">
<td align="left">EAS</td>
<td align="left">Height</td>
<td align="left">GeRS + PRS</td>
<td align="left">PRS only</td>
<td align="right">0.241</td>
<td align="right">0.216</td>
<td align="right">0.025</td>
<td align="left">4.41e-02</td>
</tr>
<tr class="even">
<td align="left">EUR</td>
<td align="left">Height</td>
<td align="left">GeRS + PRS</td>
<td align="left">PRS only</td>
<td align="right">0.328</td>
<td align="right">0.323</td>
<td align="right">0.004</td>
<td align="left">3.29e-10</td>
</tr>
</tbody>
</table>
<hr />
<p>To do:</p>
<ul>
<li>Run with more phenotypes</li>
<li>Run for other PRS methods</li>
<li>Compare methods that improve portability of EUR GWAS</li>
</ul>
</div>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->

<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_').toLowerCase();
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
